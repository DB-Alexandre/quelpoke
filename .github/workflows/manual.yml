name: Build and Push to Artifact Registry

on:
  push:
    branches:
      - main  # Déclenchement sur push vers main
  workflow_dispatch:  # Permet de déclencher manuellement depuis GitHub

jobs:
  deploy:
    name: Build & Upload Artifact
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      run: |
        gcloud auth login --quiet
        gcloud auth application-default login --quiet
        gcloud config set account ton-email@gmail.com

    - name: Configure Docker authentication
      run: gcloud auth configure-docker europe-west9-docker.pkg.dev

    - name: Generate Access Token and Authenticate Docker
      run: |
        ACCESS_TOKEN=$(gcloud auth print-access-token)
        echo $ACCESS_TOKEN | docker login -u oauth2accesstoken --password-stdin https://europe-west9-docker.pkg.dev

    - name: Build and Tag Docker Image
      run: |
        docker build -t europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/my-app:latest .
        docker tag europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/my-app:latest europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/my-app:${{ github.sha }}

    - name: Push Docker Images
      run: |
        docker push europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/my-app:latest
        docker push europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/my-app:${{ github.sha }}
