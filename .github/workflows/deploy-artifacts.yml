name: Build, Test, Push & Run Docker Container

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build, Test & Upload Artifact
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Configure Docker authentication
      run: gcloud auth configure-docker europe-west9-docker.pkg.dev

    - name: Define Image Version
      run: |
        IMAGE_VERSION=${{ github.sha }}
        echo "IMAGE_VERSION=$IMAGE_VERSION" >> $GITHUB_ENV

    - name: Build Docker Image Locally (Test)
      run: |
        echo "üê≥ Build de l'image Docker pour test..."
        docker build -t pokemon-local .

    - name: Run Docker Container Locally (Test)
      run: |
        echo "üöÄ Lancement du conteneur en test..."
        docker run -d --name pokemon-test -p 8080:8080 pokemon-local

    - name: Check if Container is Running
      run: |
        sleep 5  # Attente du d√©marrage
        if ! docker ps | grep -q "pokemon-test"; then
          echo "‚ùå ERREUR : Le conteneur ne s'est pas lanc√© correctement."
          exit 1
        fi
        echo "‚úÖ Conteneur en test lanc√© avec succ√®s !"

    - name: Verify Application Response
      run: |
        sleep 5
        if curl -s http://localhost:8080 > /dev/null; then
          echo "‚úÖ Le serveur r√©pond correctement sur http://localhost:8080"
        else
          echo "‚ùå ERREUR : Le serveur ne r√©pond pas sur http://localhost:8080"
          docker logs pokemon-test
          exit 1
        fi

    - name: Stop and Remove Test Container
      run: |
        echo "üõë Nettoyage du conteneur de test..."
        docker stop pokemon-test
        docker rm pokemon-test

    - name: Build and Tag Docker Image for Deployment
      run: |
        docker build -t europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:latest .
        docker tag europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:latest europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:$IMAGE_VERSION

    - name: Push Docker Images (if tests pass)
      run: |
        docker push europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:latest
        docker push europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:$IMAGE_VERSION

    - name: Run Deployed Docker Container
      run: |
        echo "üê≥ T√©l√©chargement et ex√©cution de l‚Äôimage depuis Artifact Registry..."
        docker pull europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:latest
        docker run -d --name pokemon-container -p 8080:8080 europe-west9-docker.pkg.dev/cs-poc-hpzdycpiqjyvinhrczvlwcn/student-alexandre/pokemon:latest
        docker ps
        echo "‚úÖ Conteneur Docker de production lanc√© avec succ√®s !"
